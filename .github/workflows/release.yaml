on:
  push:
    branches: ["sync-package"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write # Needed for auth with Deno Deploy
      contents: read # Needed to clone the repository

    steps:
      - name: Clone repository
        uses: actions/checkout@v3

      - name: Install Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18.6

      - name: Install turbo
        run: npm ci

      - name: Build step
        run: turbo prune backend

      - name: Install packages
        run: cd out && npm ci

      - name: Upload to Deno Deploy
        uses: denoland/deployctl@v1
        with:
          project: "flat-donkey-84"
          entrypoint: "out/packages/backend/src/index.ts" # üìù Update the entrypoint if necessary
          root: "." # üìù Update the root if necessary
#  release:
#    runs-on: ubuntu-latest
#    steps:
#      - name: Checkout
#        uses: actions/checkout@v3
#      - name: "Set up QEMU"
#        uses: docker/setup-qemu-action@v1
#
#      - name: "Set up Docker Buildx"
#        uses: docker/setup-buildx-action@v1
#
#      - name: "Login to GitHub Registry"
#        uses: docker/login-action@v1
#        with:
#          registry: ghcr.io
#          username: ${{ github.actor }}
#          password: ${{ secrets.GITHUB_TOKEN }}
#      - name: Build and push container
#        uses: docker/build-push-action@v3
#        with:
#          context: .
#          file: packages/backend/Dockerfile
#          push: true
#          cache-from: type=gha
#          cache-to: type=gha,mode=max
#          tags: ghcr.io/gregor-tokarev/backend:latest

